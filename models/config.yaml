# Model Configuration Template
# Copy this to config.yaml and adjust as needed

model:
  name: "spatial_graph_transformer"
  architecture: "graph_transformer"
  num_features: 33
  hidden_dim: 32
  num_layers: 2
  num_heads: 4
  dropout: 0.5
  num_classes: 8
  edge_dim: 4  # [dx, dy, euclidean_dist, network_dist]
  temperature: 4.0  # Temperature scaling for logits to prevent overconfidence (higher = flatter distribution, try 3.0-5.0)
  use_logit_norm: true  # LogitNorm: normalize logits to constant norm before softmax (prevents logit explosion)
  logit_norm: 1.0  # Target L2 norm for logits (default: 1.0, from LogitNorm paper)

training:
  batch_size: 16  # Reduced for graph model (can be larger with efficient batching)
  learning_rate: 0.0001
  weight_decay: 0.001
  num_epochs: 20  # Reduced from 100 - with early stopping patience=5, experiments finish around 20-30 epochs anyway
  early_stopping_patience: 5  # Reduced from 10 to 5 (25 training epochs instead of 50, since validation runs every 5 epochs)
  early_stopping_min_delta: 0.0005  # Reduced from 0.001 to allow smaller improvements to reset patience
  use_mixed_precision: true  # FP16 for memory savings (M2 optimization)
  gradient_accumulation_steps: 1  # Can increase to 2-4 if needed for larger effective batch size
  num_workers: 2  # DataLoader workers (2 optimal for M2 MacBook Air)
  pin_memory: false  # Not needed for MPS (Metal Performance Shaders)
  device: "auto"  # "auto" will select MPS if available, else CPU
  max_grad_norm: 1.0  # Gradient clipping to prevent logit explosion (clip gradients to this norm)
  final_layer_weight_decay: 0.01  # Extra L2 regularization on final classifier layer (helps prevent overconfidence)
  augmentation:
    enabled: true            # Toggle training-time augmentation on/off
    feature_noise_std: 0.01  # Std dev for feature noise (≈1%)
    subsample_ratio: 0.8     # Fraction of neighbors to keep
    distance_noise_std: 0.02 # Std dev for edge distance noise (≈2%)

features:
  walk_15min_radius_meters: 1000  # 15-minute walk radius in meters (default: 1000m ≈ 1.0 km)
  grid_cell_size_meters: 100  # Size of grid cells for spatial context (default: 100m × 100m)
  target_point_sampling_interval_meters: 50  # Grid spacing for target points (reduced from 100m for 4x more data)
  filter_by_network_distance: true  # Filter neighbors by network distance
  include_all_within_radius: true  # Include ALL neighbors (no truncation)

loss:
  type: "distance_similarity"  # Distance-based similarity loss using KL divergence
  temperature: 200  # Temperature parameter τ for distance-to-probability conversion (in meters)
  use_network_distance: true  # Use OSMnx network distance, not Euclidean
  missing_service_penalty: 2400  # Distance (meters) to use when service category is missing
  label_smoothing: 0.0  # Label smoothing disabled - targets are already smooth probability distributions, not one-hot
  entropy_weight: 0.0  # Disabled to let the model be confident
  min_entropy: 0.1  # Minimum entropy threshold - predictions below this are penalized (max entropy for 8 classes ≈ 2.08)
  entropy_penalty_type: "linear"  # "linear" or "quadratic" - linear is the standard approach from literature
  maxsup_weight: 0.0  # MaxSup: weight for maximum logit suppression penalty (suppresses overconfident predictions)
  maxsup_threshold: 0.0  # MaxSup: only suppress if max logit exceeds this threshold (0.0 = always apply)
  focal_gamma: 5.0  # Extreme Focal Loss: very high gamma to force model away from flat distributions

data:
  train_split: 0.7
  val_split: 0.15
  test_split: 0.15
  random_seed: 2024
  train_only_on_compliant: true  # Critical: train only on compliant neighborhoods

evaluation:
  statistical_test: "mann_whitney"  # ttest or mann_whitney
  significance_level: 0.05
  min_samples_for_test: 10

paths:
  data_root: "./data"
  neighborhoods_geojson: "./paris_neighborhoods.geojson"
  checkpoints_dir: "./models/checkpoints"
  experiments_dir: "./experiments/runs"

osm_extraction:
  buffer_meters: 100  # Buffer around neighborhood boundaries
  network_type: "walk"  # 'walk', 'drive', 'bike', 'all'
  simplify: true  # Simplify network geometry
  cache_results: true  # Skip if data already exists
  retry_attempts: 3  # Number of retries on failure
  retry_delay: 5  # Seconds between retries
  min_services_warning: 5  # Warn if fewer services found

census_extraction:
  cache_results: true  # Skip if data already exists
  retry_attempts: 3  # Number of retries on failure
  retry_delay: 5  # Seconds between retries
  paris_geocode: "75056"  # INSEE code for Paris
  iris_level: "IRIS"  # Geographic level
  min_data_warning: 10  # Warn if fewer IRIS units found
