[2026-01-20 13:15:42] [INFO] [experiment] Starting training
[2026-01-20 13:15:42] [INFO] [experiment] Using device: mps
[2026-01-20 13:15:42] [INFO] [experiment] Loading features from data/processed/features/compliant
[2026-01-20 13:15:42] [INFO] [src.training.dataset] Found 7 target_points.parquet files in data/processed/features/compliant
[2026-01-20 13:15:43] [INFO] [src.training.dataset] Combined 3636 total rows from 7 files, 7 unique neighborhoods
[2026-01-20 13:15:43] [INFO] [src.training.dataset] Created splits: Train=1844 rows (4 neighborhoods), Val=308 rows (1 neighborhoods), Test=1484 rows (2 neighborhoods)
[2026-01-20 13:15:43] [INFO] [experiment] Calculating class weights from training dataset...
[2026-01-20 13:15:43] [INFO] [experiment] Class counts: [487, 60, 478, 208, 27, 64, 479, 41]
[2026-01-20 13:15:43] [INFO] [experiment] Class weights (before damping): [3.786447525024414, 30.733333587646484, 3.857740640640259, 8.865385055541992, 68.29629516601562, 28.8125, 3.849686861038208, 44.975608825683594]
[2026-01-20 13:15:43] [INFO] [experiment] Class weights (after sqrt damping and capping at 3.0): [1.945879578590393, 3.0, 1.9641132354736328, 2.9774796962738037, 3.0, 3.0, 1.962061882019043, 3.0]
[2026-01-20 13:15:44] [INFO] [experiment] Data augmentation enabled: feature_noise (p=0.8, std=0.01), neighbor_subsampling (p=0.5, ratio=0.8), edge_noise (p=0.3, std=0.02)
[2026-01-20 13:15:44] [INFO] [experiment] Computing true class distribution from training dataset...
[2026-01-20 13:15:46] [INFO] [experiment] True distribution: ['0.1571', '0.0913', '0.1712', '0.1383', '0.0718', '0.0792', '0.1926', '0.0985']
[2026-01-20 13:15:46] [INFO] [experiment] Created datasets: Train=1844, Val=308, Test=1484
[2026-01-20 13:15:46] [INFO] [src.training.model] Created SpatialGraphTransformer: 47,752 parameters
[2026-01-20 13:15:46] [INFO] [experiment] Loss function: label_smoothing=0.0, class_weights capped at 3.0, entropy_weight=0.0, min_entropy=0.1, entropy_penalty_type=linear, maxsup_weight=0.0, maxsup_threshold=0.0, focal_gamma=5.0
[2026-01-20 13:15:46] [INFO] [experiment] Optimizer: using separate weight decay - base=0.001, final_layer=0.011
[2026-01-20 13:15:46] [INFO] [experiment] Initialized prediction distribution file: experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:15:46] [INFO] [experiment] Starting training loop
[2026-01-20 13:16:41] [INFO] [experiment] Epoch 1/20 (55.00s): train_loss=0.2758, train_top1=0.0146, train_top3=0.8308, val_loss=0.2000, val_kl=0.1902, val_top1=0.0260, val_top3=0.8409
[2026-01-20 13:17:11] [INFO] [experiment] Computing prediction distribution for epoch 1...
[2026-01-20 13:17:29] [INFO] [experiment] Epoch 1 prediction distribution: ['0.1204', '0.1316', '0.1341', '0.1224', '0.1391', '0.1066', '0.1138', '0.1320']
[2026-01-20 13:17:29] [INFO] [experiment] Updated prediction distributions to experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:17:29] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:17:29] [INFO] [experiment] New best validation loss: 0.2000 (patience counter reset to 0)
[2026-01-20 13:18:08] [INFO] [experiment] Epoch 2/20 (39.24s): train_loss=0.2685, train_top1=0.1692, train_top3=0.8476, val_loss=0.2000 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:18:44] [INFO] [experiment] Epoch 3/20 (36.30s): train_loss=0.2611, train_top1=0.2489, train_top3=0.8921, val_loss=0.2000 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:19:26] [INFO] [experiment] Epoch 4/20 (41.45s): train_loss=0.2551, train_top1=0.2538, train_top3=0.8943, val_loss=0.2000 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:20:19] [INFO] [experiment] Epoch 5/20 (53.28s): train_loss=0.2484, train_top1=0.2527, train_top3=0.9132, val_loss=0.1808, val_kl=0.1740, val_top1=0.2305, val_top3=0.8961
[2026-01-20 13:20:49] [INFO] [experiment] Computing prediction distribution for epoch 5...
[2026-01-20 13:21:06] [INFO] [experiment] Epoch 5 prediction distribution: ['0.1292', '0.1252', '0.1370', '0.1321', '0.1226', '0.1044', '0.1290', '0.1205']
[2026-01-20 13:21:06] [INFO] [experiment] Updated prediction distributions to experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:21:06] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:21:06] [INFO] [experiment] New best validation loss: 0.1808 (patience counter reset to 0)
[2026-01-20 13:21:47] [INFO] [experiment] Epoch 6/20 (41.16s): train_loss=0.2428, train_top1=0.2554, train_top3=0.9713, val_loss=0.1808 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:22:24] [INFO] [experiment] Epoch 7/20 (36.96s): train_loss=0.2383, train_top1=0.2636, train_top3=0.9761, val_loss=0.1808 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:23:00] [INFO] [experiment] Epoch 8/20 (35.81s): train_loss=0.2355, train_top1=0.2554, train_top3=0.9854, val_loss=0.1808 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:23:37] [INFO] [experiment] Epoch 9/20 (37.09s): train_loss=0.2323, train_top1=0.2549, train_top3=0.9854, val_loss=0.1808 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:24:27] [INFO] [experiment] Epoch 10/20 (50.24s): train_loss=0.2312, train_top1=0.2717, train_top3=0.9854, val_loss=0.1797, val_kl=0.1700, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:24:54] [INFO] [experiment] Computing prediction distribution for epoch 10...
[2026-01-20 13:25:10] [INFO] [experiment] Epoch 10 prediction distribution: ['0.1356', '0.1231', '0.1320', '0.1318', '0.1137', '0.1099', '0.1400', '0.1138']
[2026-01-20 13:25:10] [INFO] [experiment] Updated prediction distributions to experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:25:10] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:25:10] [INFO] [experiment] New best validation loss: 0.1797 (patience counter reset to 0)
[2026-01-20 13:25:10] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_epoch_10.pt
[2026-01-20 13:25:46] [INFO] [experiment] Epoch 11/20 (36.53s): train_loss=0.2303, train_top1=0.2614, train_top3=0.9854, val_loss=0.1797 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:26:20] [INFO] [experiment] Epoch 12/20 (34.11s): train_loss=0.2296, train_top1=0.2614, train_top3=0.9854, val_loss=0.1797 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:26:52] [INFO] [experiment] Epoch 13/20 (31.99s): train_loss=0.2289, train_top1=0.2473, train_top3=0.9854, val_loss=0.1797 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:27:26] [INFO] [experiment] Epoch 14/20 (34.05s): train_loss=0.2287, train_top1=0.2430, train_top3=0.9854, val_loss=0.1797 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:28:17] [INFO] [experiment] Epoch 15/20 (50.69s): train_loss=0.2283, train_top1=0.2554, train_top3=0.9854, val_loss=0.1790, val_kl=0.1697, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:28:42] [INFO] [experiment] Computing prediction distribution for epoch 15...
[2026-01-20 13:28:57] [INFO] [experiment] Epoch 15 prediction distribution: ['0.1357', '0.1223', '0.1291', '0.1325', '0.1110', '0.1131', '0.1425', '0.1138']
[2026-01-20 13:28:57] [INFO] [experiment] Updated prediction distributions to experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:28:57] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:28:57] [INFO] [experiment] New best validation loss: 0.1790 (patience counter reset to 0)
[2026-01-20 13:29:30] [INFO] [experiment] Epoch 16/20 (33.45s): train_loss=0.2284, train_top1=0.2641, train_top3=0.9854, val_loss=0.1790 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:30:02] [INFO] [experiment] Epoch 17/20 (31.67s): train_loss=0.2283, train_top1=0.2630, train_top3=0.9854, val_loss=0.1790 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:30:37] [INFO] [experiment] Epoch 18/20 (34.60s): train_loss=0.2279, train_top1=0.2625, train_top3=0.9854, val_loss=0.1790 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:31:08] [INFO] [experiment] Epoch 19/20 (31.85s): train_loss=0.2282, train_top1=0.2592, train_top3=0.9854, val_loss=0.1790 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:31:55] [INFO] [experiment] Epoch 20/20 (46.10s): train_loss=0.2280, train_top1=0.2592, train_top3=0.9854, val_loss=0.1780, val_kl=0.1692, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:32:19] [INFO] [experiment] Computing prediction distribution for epoch 20...
[2026-01-20 13:32:34] [INFO] [experiment] Epoch 20 prediction distribution: ['0.1353', '0.1214', '0.1280', '0.1327', '0.1101', '0.1143', '0.1437', '0.1145']
[2026-01-20 13:32:34] [INFO] [experiment] Updated prediction distributions to experiments/runs/extreme_focal_loss_test/prediction_distributions.json
[2026-01-20 13:32:34] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:32:34] [INFO] [experiment] New best validation loss: 0.1780 (patience counter reset to 0)
[2026-01-20 13:32:34] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_epoch_20.pt
[2026-01-20 13:32:34] [INFO] [experiment] Evaluating on test set and saving predictions...
[2026-01-20 13:32:59] [INFO] [experiment] Test metrics: loss=0.4251, kl=0.3962, top1=0.3484, top3=0.9522
[2026-01-20 13:33:26] [INFO] [src.evaluation.save_predictions] Saved 1484 predictions to experiments/runs/extreme_focal_loss_test/test_predictions.csv
[2026-01-20 13:33:26] [INFO] [src.evaluation.save_predictions] Saved evaluation results to experiments/runs/extreme_focal_loss_test/test_evaluation_results.json
[2026-01-20 13:33:26] [INFO] [experiment] Saved test predictions to experiments/runs/extreme_focal_loss_test/test_predictions.csv
[2026-01-20 13:33:42] [INFO] [src.evaluation.save_predictions] Saved 308 predictions to experiments/runs/extreme_focal_loss_test/val_predictions.csv
[2026-01-20 13:33:42] [INFO] [experiment] Saved validation predictions to experiments/runs/extreme_focal_loss_test/val_predictions.csv
[2026-01-20 13:33:42] [INFO] [experiment] Generating training plots...
[2026-01-20 13:33:42] [INFO] [src.evaluation.plotting] Saved training curves to experiments/runs/extreme_focal_loss_test/plots/training_training_curves.png
[2026-01-20 13:33:43] [INFO] [src.evaluation.plotting] Saved loss comparison to experiments/runs/extreme_focal_loss_test/plots/training_loss_comparison.png
[2026-01-20 13:33:43] [INFO] [src.evaluation.plotting] Saved accuracy curves to experiments/runs/extreme_focal_loss_test/plots/training_accuracy_curves.png
[2026-01-20 13:33:43] [INFO] [src.evaluation.plotting] Saved top-3 accuracy plot to experiments/runs/extreme_focal_loss_test/plots/training_top3_accuracy.png
[2026-01-20 13:33:43] [INFO] [src.evaluation.plotting] Saved all training summary plots to experiments/runs/extreme_focal_loss_test/plots
[2026-01-20 13:33:43] [INFO] [src.evaluation.plotting] Saved neighbor distribution to experiments/runs/extreme_focal_loss_test/plots/neighbor_distribution.png
[2026-01-20 13:33:44] [INFO] [src.evaluation.plotting] Saved target probability distribution to experiments/runs/extreme_focal_loss_test/plots/target_probability_distribution.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved per-class accuracy to experiments/runs/extreme_focal_loss_test/plots/test_per_class_accuracy.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved reliability diagram to experiments/runs/extreme_focal_loss_test/plots/test_calibration_reliability.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved prediction entropy plot to experiments/runs/extreme_focal_loss_test/plots/test_prediction_entropy.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved neighborhood accuracy plot to experiments/runs/extreme_focal_loss_test/plots/test_neighborhood_accuracy.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved per-class accuracy to experiments/runs/extreme_focal_loss_test/plots/val_per_class_accuracy.png
[2026-01-20 13:33:45] [INFO] [src.evaluation.plotting] Saved reliability diagram to experiments/runs/extreme_focal_loss_test/plots/val_calibration_reliability.png
[2026-01-20 13:33:46] [INFO] [src.evaluation.plotting] Saved prediction entropy plot to experiments/runs/extreme_focal_loss_test/plots/val_prediction_entropy.png
[2026-01-20 13:33:46] [INFO] [src.evaluation.plotting] Saved neighborhood accuracy plot to experiments/runs/extreme_focal_loss_test/plots/val_neighborhood_accuracy.png
[2026-01-20 13:33:46] [INFO] [experiment] Training complete
[2026-01-20 13:33:46] [INFO] [experiment] Best validation loss: 0.1780
[2026-01-20 13:33:46] [INFO] [experiment] Results saved to experiments/runs/extreme_focal_loss_test
[2026-01-20 13:33:46] [INFO] [experiment] Plots saved to experiments/runs/extreme_focal_loss_test/plots
