[2026-01-20 12:54:20] [INFO] [experiment] Starting training
[2026-01-20 12:54:20] [INFO] [experiment] Using device: mps
[2026-01-20 12:54:20] [INFO] [experiment] Loading features from data/processed/features/compliant
[2026-01-20 12:54:20] [INFO] [src.training.dataset] Found 7 target_points.parquet files in data/processed/features/compliant
[2026-01-20 12:54:22] [INFO] [src.training.dataset] Combined 3636 total rows from 7 files, 7 unique neighborhoods
[2026-01-20 12:54:22] [INFO] [src.training.dataset] Created splits: Train=1844 rows (4 neighborhoods), Val=308 rows (1 neighborhoods), Test=1484 rows (2 neighborhoods)
[2026-01-20 12:54:22] [INFO] [experiment] Calculating class weights from training dataset...
[2026-01-20 12:54:22] [INFO] [experiment] Class counts: [487, 60, 478, 208, 27, 64, 479, 41]
[2026-01-20 12:54:22] [INFO] [experiment] Class weights (before damping): [3.786447525024414, 30.733333587646484, 3.857740640640259, 8.865385055541992, 68.29629516601562, 28.8125, 3.849686861038208, 44.975608825683594]
[2026-01-20 12:54:22] [INFO] [experiment] Class weights (after sqrt damping and capping at 3.0): [1.945879578590393, 3.0, 1.9641132354736328, 2.9774796962738037, 3.0, 3.0, 1.962061882019043, 3.0]
[2026-01-20 12:54:22] [INFO] [experiment] Data augmentation enabled: feature_noise (p=0.8, std=0.01), neighbor_subsampling (p=0.5, ratio=0.8), edge_noise (p=0.3, std=0.02)
[2026-01-20 12:54:22] [INFO] [experiment] Computing true class distribution from training dataset...
[2026-01-20 12:54:24] [INFO] [experiment] True distribution: ['0.1571', '0.0913', '0.1712', '0.1383', '0.0718', '0.0792', '0.1926', '0.0985']
[2026-01-20 12:54:24] [INFO] [experiment] Created datasets: Train=1844, Val=308, Test=1484
[2026-01-20 12:54:24] [INFO] [src.training.model] Created SpatialGraphTransformer: 47,752 parameters
[2026-01-20 12:54:24] [INFO] [experiment] Loss function: label_smoothing=0.0, class_weights capped at 3.0, entropy_weight=0.1, min_entropy=0.1, entropy_penalty_type=linear, maxsup_weight=0.0, maxsup_threshold=0.0, focal_gamma=2.0
[2026-01-20 12:54:24] [INFO] [experiment] Optimizer: using separate weight decay - base=0.001, final_layer=0.011
[2026-01-20 12:54:24] [INFO] [experiment] Initialized prediction distribution file: experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 12:54:24] [INFO] [experiment] Starting training loop
[2026-01-20 12:55:17] [INFO] [experiment] Epoch 1/20 (53.19s): train_loss=0.3989, train_top1=0.0146, train_top3=0.8308, val_loss=0.2894, val_kl=0.1903, val_top1=0.0260, val_top3=0.8409
[2026-01-20 12:55:43] [INFO] [experiment] Computing prediction distribution for epoch 1...
[2026-01-20 12:55:59] [INFO] [experiment] Epoch 1 prediction distribution: ['0.1202', '0.1317', '0.1338', '0.1228', '0.1390', '0.1066', '0.1136', '0.1324']
[2026-01-20 12:55:59] [INFO] [experiment] Updated prediction distributions to experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 12:55:59] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 12:55:59] [INFO] [experiment] New best validation loss: 0.2894 (patience counter reset to 0)
[2026-01-20 12:56:38] [INFO] [experiment] Epoch 2/20 (39.09s): train_loss=0.3910, train_top1=0.1627, train_top3=0.8482, val_loss=0.2894 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 12:57:14] [INFO] [experiment] Epoch 3/20 (35.86s): train_loss=0.3833, train_top1=0.2370, train_top3=0.8921, val_loss=0.2894 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 12:57:49] [INFO] [experiment] Epoch 4/20 (34.72s): train_loss=0.3771, train_top1=0.2538, train_top3=0.8975, val_loss=0.2894 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 12:58:42] [INFO] [experiment] Epoch 5/20 (53.17s): train_loss=0.3702, train_top1=0.2527, train_top3=0.8926, val_loss=0.2725, val_kl=0.1743, val_top1=0.2305, val_top3=0.8961
[2026-01-20 12:59:07] [INFO] [experiment] Computing prediction distribution for epoch 5...
[2026-01-20 12:59:24] [INFO] [experiment] Epoch 5 prediction distribution: ['0.1282', '0.1255', '0.1364', '0.1341', '0.1225', '0.1035', '0.1281', '0.1217']
[2026-01-20 12:59:24] [INFO] [experiment] Updated prediction distributions to experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 12:59:24] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 12:59:24] [INFO] [experiment] New best validation loss: 0.2725 (patience counter reset to 0)
[2026-01-20 13:00:01] [INFO] [experiment] Epoch 6/20 (36.91s): train_loss=0.3646, train_top1=0.2533, train_top3=0.9534, val_loss=0.2725 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:00:36] [INFO] [experiment] Epoch 7/20 (35.32s): train_loss=0.3599, train_top1=0.2641, train_top3=0.9707, val_loss=0.2725 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:01:09] [INFO] [experiment] Epoch 8/20 (33.17s): train_loss=0.3572, train_top1=0.2326, train_top3=0.9848, val_loss=0.2725 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:01:44] [INFO] [experiment] Epoch 9/20 (35.15s): train_loss=0.3539, train_top1=0.2251, train_top3=0.9854, val_loss=0.2725 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:02:34] [INFO] [experiment] Epoch 10/20 (49.83s): train_loss=0.3528, train_top1=0.2332, train_top3=0.9854, val_loss=0.2726, val_kl=0.1697, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:03:01] [INFO] [experiment] Computing prediction distribution for epoch 10...
[2026-01-20 13:03:17] [INFO] [experiment] Epoch 10 prediction distribution: ['0.1342', '0.1235', '0.1313', '0.1342', '0.1138', '0.1088', '0.1397', '0.1145']
[2026-01-20 13:03:17] [INFO] [experiment] Updated prediction distributions to experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 13:03:17] [INFO] [experiment] No improvement (val_loss: 0.2726 >= best: 0.2725 - 0.0005). Patience counter: 1/5
[2026-01-20 13:03:17] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_epoch_10.pt
[2026-01-20 13:03:50] [INFO] [experiment] Epoch 11/20 (33.62s): train_loss=0.3520, train_top1=0.2354, train_top3=0.9854, val_loss=0.2726 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:04:22] [INFO] [experiment] Epoch 12/20 (31.51s): train_loss=0.3513, train_top1=0.2430, train_top3=0.9854, val_loss=0.2726 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:04:53] [INFO] [experiment] Epoch 13/20 (31.14s): train_loss=0.3506, train_top1=0.2289, train_top3=0.9854, val_loss=0.2726 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:05:28] [INFO] [experiment] Epoch 14/20 (35.42s): train_loss=0.3504, train_top1=0.2473, train_top3=0.9854, val_loss=0.2726 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:06:19] [INFO] [experiment] Epoch 15/20 (50.68s): train_loss=0.3500, train_top1=0.2343, train_top3=0.9854, val_loss=0.2719, val_kl=0.1695, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:06:43] [INFO] [experiment] Computing prediction distribution for epoch 15...
[2026-01-20 13:06:58] [INFO] [experiment] Epoch 15 prediction distribution: ['0.1342', '0.1227', '0.1283', '0.1351', '0.1112', '0.1121', '0.1422', '0.1142']
[2026-01-20 13:06:58] [INFO] [experiment] Updated prediction distributions to experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 13:06:58] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:06:58] [INFO] [experiment] New best validation loss: 0.2719 (patience counter reset to 0)
[2026-01-20 13:07:30] [INFO] [experiment] Epoch 16/20 (31.81s): train_loss=0.3501, train_top1=0.2305, train_top3=0.9854, val_loss=0.2719 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:08:00] [INFO] [experiment] Epoch 17/20 (30.28s): train_loss=0.3500, train_top1=0.2375, train_top3=0.9854, val_loss=0.2719 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:08:31] [INFO] [experiment] Epoch 18/20 (30.70s): train_loss=0.3496, train_top1=0.2397, train_top3=0.9854, val_loss=0.2719 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:09:05] [INFO] [experiment] Epoch 19/20 (33.88s): train_loss=0.3499, train_top1=0.2337, train_top3=0.9854, val_loss=0.2719 (last), val_kl=N/A, val_top1=N/A, val_top3=N/A
[2026-01-20 13:09:53] [INFO] [experiment] Epoch 20/20 (47.72s): train_loss=0.3498, train_top1=0.2050, train_top3=0.9854, val_loss=0.2707, val_kl=0.1692, val_top1=0.4156, val_top3=0.9610
[2026-01-20 13:10:18] [INFO] [experiment] Computing prediction distribution for epoch 20...
[2026-01-20 13:10:34] [INFO] [experiment] Epoch 20 prediction distribution: ['0.1337', '0.1218', '0.1270', '0.1354', '0.1106', '0.1132', '0.1434', '0.1149']
[2026-01-20 13:10:34] [INFO] [experiment] Updated prediction distributions to experiments/runs/alpha_focal_loss_test/prediction_distributions.json
[2026-01-20 13:10:34] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_best.pt
[2026-01-20 13:10:34] [INFO] [experiment] New best validation loss: 0.2707 (patience counter reset to 0)
[2026-01-20 13:10:34] [INFO] [src.training.train] Saved checkpoint to models/checkpoints/graph_transformer_epoch_20.pt
[2026-01-20 13:10:34] [INFO] [experiment] Evaluating on test set and saving predictions...
[2026-01-20 13:10:59] [INFO] [experiment] Test metrics: loss=0.6528, kl=0.3979, top1=0.3484, top3=0.9468
[2026-01-20 13:11:27] [INFO] [src.evaluation.save_predictions] Saved 1484 predictions to experiments/runs/alpha_focal_loss_test/test_predictions.csv
[2026-01-20 13:11:27] [INFO] [src.evaluation.save_predictions] Saved evaluation results to experiments/runs/alpha_focal_loss_test/test_evaluation_results.json
[2026-01-20 13:11:27] [INFO] [experiment] Saved test predictions to experiments/runs/alpha_focal_loss_test/test_predictions.csv
[2026-01-20 13:11:45] [INFO] [src.evaluation.save_predictions] Saved 308 predictions to experiments/runs/alpha_focal_loss_test/val_predictions.csv
[2026-01-20 13:11:45] [INFO] [experiment] Saved validation predictions to experiments/runs/alpha_focal_loss_test/val_predictions.csv
[2026-01-20 13:11:45] [INFO] [experiment] Generating training plots...
[2026-01-20 13:11:46] [INFO] [src.evaluation.plotting] Saved training curves to experiments/runs/alpha_focal_loss_test/plots/training_training_curves.png
[2026-01-20 13:11:46] [INFO] [src.evaluation.plotting] Saved loss comparison to experiments/runs/alpha_focal_loss_test/plots/training_loss_comparison.png
[2026-01-20 13:11:46] [INFO] [src.evaluation.plotting] Saved accuracy curves to experiments/runs/alpha_focal_loss_test/plots/training_accuracy_curves.png
[2026-01-20 13:11:46] [INFO] [src.evaluation.plotting] Saved top-3 accuracy plot to experiments/runs/alpha_focal_loss_test/plots/training_top3_accuracy.png
[2026-01-20 13:11:46] [INFO] [src.evaluation.plotting] Saved all training summary plots to experiments/runs/alpha_focal_loss_test/plots
[2026-01-20 13:11:47] [INFO] [src.evaluation.plotting] Saved neighbor distribution to experiments/runs/alpha_focal_loss_test/plots/neighbor_distribution.png
[2026-01-20 13:11:47] [INFO] [src.evaluation.plotting] Saved target probability distribution to experiments/runs/alpha_focal_loss_test/plots/target_probability_distribution.png
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved per-class accuracy to experiments/runs/alpha_focal_loss_test/plots/test_per_class_accuracy.png
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved reliability diagram to experiments/runs/alpha_focal_loss_test/plots/test_calibration_reliability.png
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved prediction entropy plot to experiments/runs/alpha_focal_loss_test/plots/test_prediction_entropy.png
/Users/maayanchen/Code/University/AI4SI_Project/src/evaluation/plotting.py:221: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  grouped = predictions_df.groupby("neighborhood_name").apply(
/Users/maayanchen/Code/University/AI4SI_Project/src/evaluation/plotting.py:234: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
  ax.set_xticklabels(grouped.index, rotation=45, ha="right", fontsize=8)
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved neighborhood accuracy plot to experiments/runs/alpha_focal_loss_test/plots/test_neighborhood_accuracy.png
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved per-class accuracy to experiments/runs/alpha_focal_loss_test/plots/val_per_class_accuracy.png
[2026-01-20 13:11:48] [INFO] [src.evaluation.plotting] Saved reliability diagram to experiments/runs/alpha_focal_loss_test/plots/val_calibration_reliability.png
[2026-01-20 13:11:49] [INFO] [src.evaluation.plotting] Saved prediction entropy plot to experiments/runs/alpha_focal_loss_test/plots/val_prediction_entropy.png
/Users/maayanchen/Code/University/AI4SI_Project/src/evaluation/plotting.py:221: FutureWarning: DataFrameGroupBy.apply operated on the grouping columns. This behavior is deprecated, and in a future version of pandas the grouping columns will be excluded from the operation. Either pass `include_groups=False` to exclude the groupings or explicitly select the grouping columns after groupby to silence this warning.
  grouped = predictions_df.groupby("neighborhood_name").apply(
/Users/maayanchen/Code/University/AI4SI_Project/src/evaluation/plotting.py:234: UserWarning: set_ticklabels() should only be used with a fixed number of ticks, i.e. after set_ticks() or using a FixedLocator.
  ax.set_xticklabels(grouped.index, rotation=45, ha="right", fontsize=8)
[2026-01-20 13:11:49] [INFO] [src.evaluation.plotting] Saved neighborhood accuracy plot to experiments/runs/alpha_focal_loss_test/plots/val_neighborhood_accuracy.png
[2026-01-20 13:11:49] [INFO] [experiment] Training complete
[2026-01-20 13:11:49] [INFO] [experiment] Best validation loss: 0.2707
[2026-01-20 13:11:49] [INFO] [experiment] Results saved to experiments/runs/alpha_focal_loss_test
[2026-01-20 13:11:49] [INFO] [experiment] Plots saved to experiments/runs/alpha_focal_loss_test/plots

============================================================
Training Complete!
============================================================
Best validation loss: 0.2707
Total epochs: 20
Test loss: 0.6528
Test KL divergence: 0.3979
Test top-1 accuracy: 0.3484
Results saved to: experiments/runs/alpha_focal_loss_test
Checkpoint saved to: models/checkpoints/graph_transformer_best.pt
============================================================
